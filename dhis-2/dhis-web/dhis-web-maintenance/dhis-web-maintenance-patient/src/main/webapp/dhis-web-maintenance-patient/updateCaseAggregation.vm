<script type="text/javascript" src="javascript/updateCaseAggregationForm.js"></script>

<h3>$i18n.getString( "edit_case_aggregation_condition" )</h3>

<form id="updateCaseAggregationForm" action="updateCaseAggregation.action" method="post" >

<input type='hidden' id='id' name='id' value='$caseAggregation.id'>
<table> 
	<thead>
      <tr>
        <th colspan="2">$i18n.getString( "case_aggregation_condition_detail" )</th>
      </tr>
    </thead>
	
    <tbody>
	
    <tr>
        <td><label>$i18n.getString( "name" ) <em title="$i18n.getString( "required" )" class="required">*</em></label></td>
        <td><input type="text" id="name" name="name" class="{validate:{required:true}}" value="$caseAggregation.name"></td>
    </tr>
    
    <tr>
		<td><label for="dataSets">$i18n.getString( "dataset" )</label></td>
		<td>
			<select id="dataSets" name="dataSets" onchange="getDataElementsByDataset();">
				<option value="">[$i18n.getString('please_select')]</option>
				#foreach( $dataSet in $dataSets)
					<option value="$dataSet.id" #if( $dataSetId=="$dataSet.id") selected #end >$dataSet.name</option>
				#end
			</select>
		</td>				
	</tr>
    
    <tr>
		<td><label for="dataElement">$i18n.getString( "dataelement" )<em title="$i18n.getString( "required" )" class="required">*</em></label></td>
		<td>
			<input id="aggregationDataElementInput" name="aggregationDataElementInput" value='$caseAggregation.aggregationDataElement.name $caseAggregation.optionCombo.name' style='width:303px'>
			<button type='button' id='dataElementsButton' disabled>&nbsp;</button>
			<input id="aggregationDataElementId" name="aggregationDataElementId" value="$caseAggregation.aggregationDataElement.id.$caseAggregation.optionCombo.id" class="{validate:{required:true}} hidden" >
		</td>				
	</tr>
	<tr>
		<td><label for="operator">$i18n.getString( "operator" )</label></td>
		<td>
			<input type="radio" id="operator" name="operator" value="COUNT" #if($caseAggregation.operator=="COUNT") checked #end >  $i18n.getString('number_of_patients')
			<input type="radio" id="operator" name="operator" value="SUM" #if($caseAggregation.operator=="SUM") checked #end > $i18n.getString('number_of_visits')
		</td>
	</tr>
	<tr>
		<td>
			<label for="programId">$i18n.getString( "program" )</label>
		</td>
		<td>
			<select id="programId" name="programId" onChange="getParams();">
				<option value="">[$i18n.getString('please_select')]</option>
				#foreach( $program in $programs )
					<option value="$program.id" title='$program.name'>$encoder.htmlEncode( $program.name )</option>
				#end
			</select>
		</td>
	</tr>
	
	<tr>
		<td>
			<label for="programStage">$i18n.getString( "program_stage" )</label>
		</td>
		<td>
			<select id="programStageId" name="programStageId" onChange="getPatientDataElements();" ondblclick="insertProgramStage(this);"></select>
		</td>
	</tr>
	
	<tr>
        <td colspan="2"><p></p></td>
    </tr>
	
    </tbody>
</table>

<div id="tabs">
	<ul>
		<li><a href="#tab-1">$i18n.getString("dataelements")</a></li>
		<li><a href="#tab-2">$i18n.getString("patient_attributes")</a></li>
		<li><a href="#tab-3">$i18n.getString("program")</a></li>
	</ul>	
	
	<div id="tab-1">
	  <table>
        <tr>
			<td><label for="dataelement">$i18n.getString( "dataelement" )</label></td>
			<td>
				<label for="availableValues">$i18n.getString( "available_values" )</label>&nbsp;
				<button title="$i18n.getString( 'insert_selected_values' )" class='arrow-down' onClick="insertMultiValues('suggestedDEValues');" />			</td>
        </tr>
        
        <tr>
			<td>
				<input type='text' id='txtSearchValue' name='txtSearchValue' onKeyUp="filterDE(event, this.value, 'dataElements');" style='width:270px'/>
				<input type='button' value='$i18n.getString("clear")' onClick="setFieldValue('txtSearchValue', '');" style='width:50px'>			</td>
            <td rowspan="4">
				<select name="suggestedDEValues" size="10" multiple id='suggestedDEValues' ondblclick="insertSingleValue('suggestedDEValues');" >
			    </select>			</td>
        </tr>
        <tr>
			<td>
				<select id="dataElements" name="dataElements" size="8" ondblclick="insertDataElement(this);" onclick="getSuggestedValues(this.id, 'suggestedDEValues' )"></select>			</td>
		</tr>
      </table>
	</div>
	
	<div id="tab-2">
		<table>
			<tr>
				<td><label>$i18n.getString( "patient_attributes" )</label></td>
				<td>
					<label>$i18n.getString( "available_values" )</label>
					<button title="$i18n.getString( 'insert_selected_values' )" class='arrow-down' onClick="insertMultiValues('caSuggestedValues');" />
				</td>
			</tr>
			<tr>
				<td>
					<select id="caseProperty" name="caseProperty" size="10" ondblclick="insertInfo(this, false);" onclick="getSuggestedValues(this.id, 'caSuggestedValues' )"></select>
				</td>
				<td>
					<select multiple size="10" id='caSuggestedValues' ondblclick="insertSingleValue('caSuggestedValues');"></select>
				</td>
			</tr>
		</table>
	</div>
	
	<div id="tab-3">
		<table>
			<tr>
				<td><label>$i18n.getString('program_properties')</label></td>
				<td><label>$i18n.getString('program_stage_properties')</label></td>
			</tr>
			<tr>
				<td>
					<select id="programProperty" name="programProperty" size="10" ondblclick="insertInfo(this, false);" disabled>
						<option value="[PG:*]">$i18n.getString( "program_enrollment" )</option>
						<option value="[PG:*] AND [PP:DATE@enrollmentdate#-DATE@dateofincident#]">$i18n.getString( "date_of_enrollment" ) - $i18n.getString( "date_of_incident" )</option>
					</select>
				</td>
				<td>
					<select multiple id="programStageProperty" size="10"  name="programStageProperty" ondblclick="insertInfo(this, true);" disabled >
						<option value="[PS:*]">$i18n.getString( "visit_program_stage" )</option>
						<option value="[PS:*] AND [PSP:DATE@executionDate#-DATE@dueDate#]">$i18n.getString( "report_date" ) - $i18n.getString( "due_date" )</option>
						<option value="[PS:*] AND [PC:DATE@executionDate#-DATE@birthDate#]">$i18n.getString( "report_date" ) - $i18n.getString( "date_of_birth" )</option>
					</select>
					</select>
				</td>
			</tr>
		</table>
	</div>
	
</div>

<p></p>
<table>
	<tr>
		<td>
			<img src="../images/less.png" alt="$i18n.getString( 'less' )" onclick='insertOperator( "<" );' style="cursor:pointer;">
			<img src="../images/less_or_equal.png" alt="$i18n.getString( 'less_or_equal' )" onclick='insertOperator( "<=" );' style="cursor:pointer;">
			<img src="../images/greater.png" alt="$i18n.getString( 'greater' )" onclick='insertOperator( ">" );' style="cursor:pointer;">
			<img src="../images/greater_or_equal.png" alt="$i18n.getString( 'greater_or_equal' )" onclick='insertOperator( ">=" );' style="cursor:pointer;">
			<img src="../images/equal.png" alt="$i18n.getString( 'equal' )" onclick='insertOperator( "=" );' style="cursor:pointer;">
			<img src="../images/diff.png" alt="$i18n.getString( 'diff' )" onclick='insertOperator( "!=" );' style="cursor:pointer;">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<img src="../images/plus.png" alt="$i18n.getString( 'plus' )" onclick='insertOperator( "+" );' style="cursor:pointer;">
			<img src="../images/left_parent.png" alt="$i18n.getString( 'left_parent' )" onclick='insertOperator( "(" );' style="cursor:pointer;"/>
			<img src="../images/right_parent.png" alt="$i18n.getString( 'right_parent' )" onclick='insertOperator( ")" );' style="cursor:pointer;"/>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<img src="images/yes.png" alt="$i18n.getString( 'yes' )" onclick='insertOperator( "true" );' style="cursor:pointer;"/>
			<img src="images/no.png" alt="$i18n.getString( 'no' )" onclick='insertOperator( "false" );' style="cursor:pointer;"/>
			<img src="../images/is_null.png" alt="$i18n.getString( 'is_null' )" onclick='insertOperator( "is null" );' style="cursor:pointer;">
			<img src="../images/not_null.png" alt="$i18n.getString( 'not_null' )" onclick='insertOperator( "is not null" );' style="cursor:pointer;">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<img src="../images/and.png" alt="$i18n.getString( 'and' )" onclick='insertOperator( "AND" );' style="cursor:pointer;">
			<img src="../images/or.png" alt="$i18n.getString( 'or' )" onclick='insertOperator( "OR" );' style="cursor:pointer;">
			
			<img src="../images/clear.png" align="right" alt="$i18n.getString( 'clear' )" onclick="byId('aggregationCondition').value='';" style="cursor:pointer;">
		</td>
	
    </tbody>
	<tr>
		<td>
			<fieldset>
				<legend>$i18n.getString( "condition" )</legend>
				<textarea id="aggregationCondition" name="aggregationCondition" class="{validate:{required:true}}" onkeyup='getConditionDescription();'>$caseAggregation.aggregationExpression</textarea>
			</fieldset>
		</td>
	</tr>
	
	<tr>
		<td>
			<fieldset>
				<legend>$i18n.getString( "description" )</legend>
				<div id='aggregationDescription'>$!description</div>
			</fieldset>
		</td>
	</tr>
	<tr>
		<td>
			<input type="submit" value="$i18n.getString( 'update' )" >
			<input type="button" value="$i18n.getString( 'test_condition' )" onclick='testCaseAggregationCondition();'/>
			<input type="button" value="$i18n.getString( 'cancel' )" onclick="window.location.href='caseAggregation.action?dataSetId=$!dataSetId'" >
		</td>
	<tr>
</table>

</form>

<script>
	#if( $dataSetId )
		getDataElementsByDataset();
		var selectedValue = "$caseAggregation.aggregationDataElement.id" + "." + "$caseAggregation.optionCombo.id";
		jQuery("#aggregationDataElementId").val( selectedValue );
	#end	
	
	var i18n_run_success = '$encoder.jsEscape( $i18n.getString( "run_success" ) , "'" )';
	var i18n_run_fail = '$encoder.jsEscape( $i18n.getString( "run_fail" ) , "'" )';
	var i18n_show_all_items = '$encoder.jsEscape( $i18n.getString( "show_all_item" ) , "'" )';
	var i18n_all = '[' + '$encoder.jsEscape( $i18n.getString( "all" ) , "'" )' + ']';
</script>
